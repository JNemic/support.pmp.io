# Authentication

API users are given a `username` and `password`.  These cannot be used directly to authenticate with the PMP - rather they are used to manage multiple API client credentials under a single user account.  The PMP uses an OAuth2 [Client Credentials](http://techblog.hybris.com/2012/07/09/oauth-the-client-credentials-flow/) flow, meaning you'll be generating a separate `client_id` and `client_secret` for each application that will use the API.

Normally, you should use the [support site](http://support.pmp.io/credentials).  This section is for reference, in case you want to manage them manually.

<div class="alert alert-warning">You should NEVER use your username/password into an applicaton - just client_id/client_secret!</div>

## Credential List

See `urn:collectiondoc:form:listcredentials` in [the home doc](https://api.pmp.io).

```shell
curl -u "username:password" -X GET "https://api.pmp.io/auth/credentials"

# returns a json string
# {
#   "clients": [
#     {
#       "client_id": "405a022e-6274-4170-8eba-67933551c3c3",
#       "client_secret": "22c2dbdc03d72e18cb01dee1",
#       "scope": "write",
#       "label": "hello world",
#       "token_expires_in": 1209600
#     }
#   ]
# }
```

```javascript
var PmpSdk = require('pmpsdk');
var sdk = new PmpSdk({username: 'u', password: 'p', host: 'https://api.pmp.io'});

sdk.credList(function(resp) {
  console.log(resp.status);  // 200
  console.log(resp.success); // true
  console.log(resp.radix);   // [{...client object...}, {...}]
});
```

## Credential Creation

See `urn:collectiondoc:form:createcredentials` in [the home doc](https://api.pmp.io).

* Uses the "publish" endpoint
* Must have header `Content-Type: application/x-www-form-encoded`
* These optional form parameters may be included:

Parameter       | Default   | Usage
--------------- | --------- | -----
scope           | write     | "read" or "write", indicating if this client can write to the API
label           | *(blank)* | human readable label for this client
token_exires_in | 1209600   | number of seconds a token generated by this client will last, until it needs to be re-requested

```shell
curl -u "username:password" -X POST -H "Content-Type: application/x-www-form-urlencoded" "https://publish.pmp.io/auth/credentials" -d "scope=read" -d "token_expires_in=999999" -d "label=somethingCool"

# returns a json string
# {
#   "client_id": "405a022e-6274-4170-8eba-67933551c3c3",
#   "client_secret": "22c2dbdc03d72e18cb01dee1",
#   "token_expires_in": 999999,
#   "scope": "read",
#   "label": "somethingCool"
# }
```

```javascript
var PmpSdk = require('pmpsdk');
var sdk = new PmpSdk({username: 'u', password: 'p', host: 'https://api.pmp.io'});

sdk.credCreate('somethingCool', 'read', 999999, function(resp) {
  console.log(resp.status);  // 200
  console.log(resp.success); // true
  console.log(resp.radix);   // {...client object...}
});
```

## Credential Deletion

See `urn:collectiondoc:form:removecredentials` in [the home doc](https://api.pmp.io).

* Uses the "publish" endpoint
* Include the `client_id` in the URL

```shell
curl -u "username:password" -X DELETE "https://publish.pmp.io/auth/credentials/405a022e-6274-4170-8eba-67933551c3c3"

# returns 204 - no content
```

```javascript
var PmpSdk = require('pmpsdk');
var sdk = new PmpSdk({username: 'u', password: 'p', host: 'https://api.pmp.io'});

sdk.credDestroy('405a022e-6274-4170-8eba-67933551c3c3', function(resp) {
  console.log(resp.status);  // 204
  console.log(resp.success); // true
});
```

## Token Creation

To begin making requests to the API, you'll need a non-expired bearer token.  This is normally handled transparently by the client sdk, but if you'd like to get one manually...

See `urn:collectiondoc:form:issuetoken` in [the home doc](https://api.pmp.io).

* DOES NOT use the "publish" endpoint, even though it is a POST request
* The Content-Type header must be set to `application/x-www-form-encoded`
* `client_id`/`client_secret` should be included as the basic auth
* Must send the form parameter `grant_type=client_credentials`

```shell
curl -u "client_id:client_secret" -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "grant_type=client_credentials" "https://api.pmp.io/auth/access_token"

# returns a json string
# {
#   "access_token": "3f2401ae1a74adf8b14a638a",
#   "token_type": "Bearer",
#   "token_issue_date": "2014-08-25T20:05:19+00:00",
#   "token_expires_in": 999634
# }
```

```javascript
var PmpSdk = require('pmpsdk');
var sdk = new PmpSdk({client_id: '1', client_secret: '2', host: 'https://api.pmp.io'});

sdk.token(function(token) {
  console.log(token); // "3f2401ae1a74adf8b14a638a"
  // or null (if unauthorized, bad host, etc)
});
```

In the response, `token_expires_in` is the number seconds until this `access_token` will expire and your client will need to request a new one.  Re-requesting a non-expired token for the same client will return the same `access_token`.  SDK's *should* automatically re-request the token when it expires.

## Token Deletion

See `urn:collectiondoc:form:revoketoken` in [the home doc](https://api.pmp.io).

* Uses the "publish" endpoint
* HTTP `DELETE` request

```shell
curl -u "client_id:client" -X DELETE "https://api.pmp.io/auth/access_token"

# returns 204 - no content
```

```javascript
// the javascript sdk doesn't provide an explicit way to do this
```

## Usage

Now that you've completed the OAuth2 flow, you can make authenticated requests against the API.  Just include the header `Authorization: Bearer YOURTOKENHERE`.  For instance, to fetch a document...

```shell
curl -H "Authorization: Bearer 3f2401ae1a74adf8b14a638a" -X GET "https://api.pmp.io/docs/04224975-e93c-4b17-9df9-96db37d318f3"

# returns a big collection+doc json string
```

```javascript
var PmpSdk = require('pmpsdk');
var sdk = new PmpSdk({client_id: '1', client_secret: '2', host: 'https://api.pmp.io'});

sdk.fetchDoc('04224975-e93c-4b17-9df9-96db37d318f3', (doc, resp) {
  console.log(resp.status);          // 200
  console.log(resp.success);         // true
  console.log(doc.attributes.guid);  // "04224975-e93c-4b17-9df9-96db37d318f3"
  console.log(doc.attributes.title); // "PMP Home Document"
});
```
